name: DiagnÃ³stico de conexiÃ³n FTP

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Mostrar entorno
        run: |
          echo "Runner: $(uname -a)"
          echo "Probando conexiÃ³n a ${{ secrets.FTP_SERVER }}"

      - name: Verificar resoluciÃ³n DNS
        run: |
          echo "ðŸ” DNS Lookup:"
          nslookup ${{ secrets.FTP_SERVER }} || dig ${{ secrets.FTP_SERVER }}

      - name: Probar conexiÃ³n TCP (puerto 21 FTP)
        run: |
          echo "âš¡ Probar FTP (puerto 21)"
          nc -vz ${{ secrets.FTP_SERVER }} 21 || echo "âŒ No se pudo conectar al puerto 21"

      - name: Probar conexiÃ³n TCP (puerto 22 SFTP)
        run: |
          echo "âš¡ Probar SFTP (puerto 22)"
          nc -vz ${{ secrets.FTP_SERVER }} 22 || echo "âŒ No se pudo conectar al puerto 22"

      - name: Probar conexiÃ³n TCP (puerto 990 FTPS implÃ­cito)
        run: |
          echo "âš¡ Probar FTPS (puerto 990)"
          nc -vz ${{ secrets.FTP_SERVER }} 990 || echo "âŒ No se pudo conectar al puerto 990"

      - name: Intentar login FTP bÃ¡sico
        run: |
          echo "ðŸ§ª Probando conexiÃ³n FTP simple..."
          echo "user ${{ secrets.FTP_USERNAME }}" > ftp_cmds.txt
          echo "pass ${{ secrets.FTP_PASSWORD }}" >> ftp_cmds.txt
          echo "quit" >> ftp_cmds.txt
          ftp -inv ${{ secrets.FTP_SERVER }} < ftp_cmds.txt || echo "âŒ No se pudo autenticar FTP"

      - name: Intentar login FTPS
        run: |
          echo "ðŸ§ª Probando conexiÃ³n FTPS..."
          lftp -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ftps://${{ secrets.FTP_SERVER }} -e "ls; bye" || echo "âŒ No se pudo autenticar FTPS"

      - name: Intentar login SFTP
        run: |
          echo "ðŸ§ª Probando conexiÃ³n SFTP..."
          apt-get update -y && apt-get install -y openssh-client
          sftp -oBatchMode=no -b - ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} <<EOF || echo "âŒ No se pudo autenticar SFTP"
          ls
          bye
          EOF
